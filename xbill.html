<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>XBill</title>

    <link rel="icon" href="xbill.gif" />

    <style>
      /* Gotta have that GitHub banner. */
      /* Wouldn't want anybody not taking this thing seriously. */
      .github_fork_ribbon {
        position: absolute;
        overflow: hidden;
        top: 0;
        right: 0;
        z-index: 9999;
        text-decoration: none;
      }

      body {
        background-image: url('wallpaper.png');
        font-family: sans-serif;
        margin: auto;
        max-width: 800px;
      }

      /* There can't be any border or padding on the game canvases,
         or mouse event coordinates won't be correct. */
      canvas {
        padding: 0;
        border: 0px none;
      }

      section {
        border-image-source: url('xbill_window_frame.png');
        border-image-slice: 25 45 27 45;
        border-image-width: 25px 45px 27px 45px;
        border-image-outset: 25px 8px 8px 8px;
        border-image-repeat: round stretch;

        margin-right: auto;
        margin-left: auto;
        margin-top: 50px;
        margin-bottom: 50px;

        background: #CECECE;
      }

      #header_logo {
        width: 261px;
        padding: 20px;
      }

      #game_container {
        width: 400px;
        background-color: white;
      }

      #button_container {
        text-align: center;
        padding: 20px;
      }
      button {
        padding: 5px 10px 5px;
      }

      h2,
      table caption {
        font-size: 1.5em;
        font-weight: bold;
        margin-top: .5em;
        margin-bottom: .5em;
        text-align: center;
      }

      .text-section {
        padding-top: 5px;
        padding-bottom: 5px;
        padding-left: 10px;
        padding-right: 10px;
      }

      /* The high scores table */
      table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
      }
      table tr {
        border: 1px solid #aaa;
      }
      table th {
        background-color: #aaa;
      }
      table th,
      table td {
        padding: .625em;
        text-align: center;
      }

    </style>
  </head>
  <body>
    <a href="https://github.com/DrGoldfire/WebBill" class="github_fork_ribbon">
      <img alt="Fork me on GitHub"
           src="https://github.blog/wp-content/uploads/2008/12/forkme_right_gray_6d6d6d.png?resize=149%2C149">
    </a>

    <section id="header_logo">
      <img src="xbill_header_logo.png" />
    </section>

    <section id="game_container">
      <div id="button_container">
        <button id="btnNewGame">New Game</button>
        <button id="btnPause">Pause</button>
        <button id="btnResume" style="display:none">Resume</button>
        <button id="btnWarp">Warp to Level</button>
      </div>
      <!-- Use two canvases in order to implement a double buffer; only one is visible at a time. -->
      <canvas id="canvas0" oncontextmenu="event.preventDefault()"></canvas>
      <canvas id="canvas1" style="display:none" oncontextmenu="event.preventDefault()"></canvas>
    </section>

    <section id="highscores" class="text-section">
      <table id="highscores_table">
        <caption>High Scores</caption>
        <tbody id="highscores_body"></tbody>
      </table>
    </section>

    <section id="story" class="text-section">
      <h2>The Story</h2>
      <p>
      Yet again, the fate of the world rests
      in your hands! An evil computer hacker,
      known only by his handle 'Bill', has
      created the ultimate computer virus. A
      virus so powerful that it has the power
      to transmute an ordinary computer into
      a toaster oven. (oooh!) 'Bill' has
      cloned himself into a billion-jillion
      micro-Bills. Their sole purpose is to
      deliver the nefarious virus, which has
      been cleverly diguised as a popular
      operating system.
      <p>
      As System Administrator/Exterminator,
      your job is to keep Bill from succeeding
      at his task.
    </section>

    <section id="rules" class="text-section">
      <h2>The Rules</h2>
      <p>
      xBill has been painstakingly designed and
      researched in order to make it as easy to use
      for the whole family as it is for little Sally.
      Years - nay - days of beta testing and
      consulting with the cheapest of human interface
      designers have resulted in a game that is easy
      to use, yet nothing at all like a Macintosh.

      <ol>
        <li>Whack the Bills (click)</li>
        <li>Restart the computer (click)</li>
        <li>Pick up stolen OSes & return (drag) them
            to their respective computers</li>
        <li>Drag the bucket to extinguish sparks</li>
        <li>Scoring is based on total uptime, with
            bonuses for killing Bills.</li>
      </ol>

      <p>
      As for the rest, you can probably figure
      it out.  We did, so it can't be too hard.
    </section>

    <section id="about" class="text-section">
      <h2>About XBill</h2>
      <p>
      <a href="http://xbill.org/">XBill</a>
      is a game by Brian Wellington and Matias Duarte.
      This WebAssembly port was done by Matt Howell
      (<a href="https://twitter.com/DrGoldfire">@DrGoldfire on Twitter</a>).
      The original game and this port are distributed under the terms of the
      GNU General Public License. The original source distribution is missing
      any GPL version number, so I've designated this port to be under GPL 2.0.
    </section>

    <script type='text/javascript'>
      // Set up some globals that library.js will need.
      // The game's X pixmap format images, parsed into ImageData and mapped by name.
      let gPixmaps = new Map();
      let gImages = new Map();
      // The "active" frame buffer (canvas) is the one we're currently rendering into,
      // *not* the one that is currently being shown.
      let gActiveCanvas = 1;
      // The timer that sets off the game update.
      let gTimer = null;
      // The rate of the game update timer (in milliseconds)
      let gTimerRate = 0;

      // Utility functions for library.js.
      function active_canvas() {
        return document.getElementById("canvas" + gActiveCanvas);
      }
      function active_context() {
        return active_canvas().getContext("2d");
      }

      // Event handlers for the mouse inside the game canvas.
      document.getElementById("canvas0").onmousedown =
      document.getElementById("canvas1").onmousedown =
      function(event) {
        ccall("Game_button_press", null, ["number", "number"],
          [event.offsetX, event.offsetY]);
      };
      document.getElementById("canvas0").onmouseup =
      document.getElementById("canvas1").onmouseup =
      function(event) {
        ccall("Game_button_release", null, ["number", "number"],
          [event.offsetX, event.offsetY]);
      };

      // Click handlers for our action buttons.
      document.getElementById("btnNewGame").onclick = function() {
        _js_stop_timer();
        document.getElementById("btnPause").style.display = "inline";
        document.getElementById("btnResume").style.display = "none";

        ccall("Game_start", null, ["number"], [1]);
      };

      document.getElementById("btnPause").onclick = function() {
        this.style.display = "none";
        document.getElementById("btnResume").style.display = "inline";
        _js_stop_timer();
      };
      document.getElementById("btnResume").onclick = function() {
        this.style.display = "none";
        document.getElementById("btnPause").style.display = "inline";
        _js_start_timer(gTimerRate);
      };

      document.getElementById("btnWarp").onclick = function() {
        ccall("Game_warp_to_level", null, ["number"],
          [prompt("Warp to level:")]);
      };
    </script>
    <script async type="text/javascript" src="xbill.js"></script>
  </body>
</html>
